import Simpleuml: 'http://www.eclipse.org/qvt/examples/0.1/simpleUML';
import Simplerdbms: 'http://www.eclipse.org/qvt/examples/0.1/SimpleRDBMS';
import Umltordbms: 'http://www.eclipse.org/qvt/examples/0.1/UMLtoRDBMS';

transformation umlRdbms {
    uml imports Simpleuml; 
    rdbms imports Simplerdbms; 
    middle imports Umltordbms; 
}

map packageToSchema_LM in umlRdbms {        
    uml (p:Package) {
    }        
    enforce middle () {
        realize p2s:PackageToSchema    }    
    where () {
        
        p2s.umlPackage := p;        
        p2s.name := p.name;    }
}

map packageToSchema_MR in umlRdbms {        
    enforce rdbms () {
        realize s:Schema    }        
    check middle (p2s:PackageToSchema) {
    }    
    where () {
        
        p2s.schema := s;        
        s.name := p2s.name;    }
}

map integerToNumber_LM in umlRdbms {        
    uml (p:Package,
        prim:PrimitiveDataType) {
    }        
    enforce middle (p2s:PackageToSchema) {
        realize p2n:IntegerToNumber    }    
    where () {
        
        p2n.primitive := prim;        
        p2n.name := prim.name.+('2').+('NUMBER');        
        p2n.owner := p2s;    }
}

map integerToNumber_MR in umlRdbms {        
    enforce rdbms () {
        realize sqlType:String    }        
    check middle (p2s:PackageToSchema,
        p2n:IntegerToNumber) {
    }    
    where () {
        
        p2n.typeName := sqlType;        
        sqlType := 'NUMBER';    }
}

map booleanToBoolean_MR in umlRdbms {        
    enforce rdbms () {
        realize sqlType:String    }        
    check middle (p2s:PackageToSchema,
        p2n:BooleanToBoolean) {
    }    
    where () {
        
        p2n.typeName := sqlType;        
        sqlType := 'BOOLEAN';    }
}

map booleanToBoolean_LM in umlRdbms {        
    uml (p:Package,
        prim:PrimitiveDataType) {
    }        
    enforce middle (p2s:PackageToSchema) {
        realize p2n:BooleanToBoolean    }    
    where () {
        
        p2n.primitive := prim;        
        p2n.owner := p2s;        
        p2n.name := prim.name.+('2').+('BOOLEAN');    }
}

map stringToVarchar_MR in umlRdbms {        
    enforce rdbms () {
        realize sqlType:String    }        
    check middle (p2s:PackageToSchema,
        p2n:StringToVarchar) {
    }    
    where () {
        
        p2n.typeName := sqlType;        
        sqlType := 'VARCHAR';    }
}

map stringToVarchar_LM in umlRdbms {        
    uml (p:Package,
        prim:PrimitiveDataType) {
    }        
    enforce middle (p2s:PackageToSchema) {
        realize p2n:StringToVarchar    }    
    where () {
        
        p2n.primitive := prim;        
        p2n.owner := p2s;        
        p2n.name := prim.name.+('2').+('VARCHAR');    }
}

map classToTable_LM in umlRdbms {        
    check uml (p:Package,
        c:Class) {
    }        
    enforce middle (p2s:PackageToSchema) {
        realize c2t:ClassToTable    }    
    where () {
        
        c2t.umlClass := c;        
        c2t.owner := p2s;        
        c2t.name := c.name;    }
}

map classToTable_MR in umlRdbms {        
    enforce rdbms (s:Schema) {
        realize t:Table,
        realize pk:Key,
        realize pc:Column    }        
    check middle (p2s:PackageToSchema,
        c2t:ClassToTable) {
    }    
    where () {
        
        c2t.column := pc;        
        c2t.primaryKey := pk;        
        c2t.table := t;        
        t.name := c2t.name;        
        t.kind := 'base';        
        t.schema := s;        
        pk.owner := t;        
        pk.kind := 'primary';        
        pc.owner := t;        
        pc.keys := Set{pk};        
        pc.type := 'NUMBER';        
        pc.name := t.name.+('_tid');        
        pk.name := t.name.+('_pk');    }
}

map associationToForeignKey_MR in umlRdbms {        
    enforce rdbms (s:Schema,
        st:Table,
        dt:Table,
        rk:Key) {
        realize fk:ForeignKey,
        realize fc:Column    }        
    check middle (p2s:PackageToSchema,
        sc2t:ClassToTable,
        dc2t:ClassToTable,
        a2f:AssociationToForeignKey) {
    }    
    where () {
        
        fc.type := rk.column->first().type;        
        fk.name := a2f.name;        
        fc.name := a2f.name.+('_tid');        
        a2f.foreignKey := fk;        
        a2f.column := fc;        
        fk.owner := st;        
        fc.owner := st;        
        fk.refersTo := rk;        
        fc.foreignKeys := Set{fk};    }
}

map associationToForeignKey_LM in umlRdbms {        
    check uml (p:Package,
        sc:Class,
        dc:Class,
        a:Association) {
    }        
    enforce middle (p2s:PackageToSchema,
        sc2t:ClassToTable,
        dc2t:ClassToTable) {
        realize a2f:AssociationToForeignKey    }    
    where () {
        
        a2f.referenced := dc2t;        
        a2f.name := if a.destination.=(dc).and(a.source.=(sc)) then a.name else if a.destination.<>(dc).and(a.source.=(sc)) then dc.name.+('_').+(a.name) else if a.destination.=(dc).and(a.source.<>(sc)) then a.name.+('_').+(sc.name) else dc.name.+('_').+(a.name).+('_').+(sc.name) endif endif endif;        
        a2f.owner := sc2t;        
        a2f.association := a;        
        a.name := if a.destination.=(dc).and(a.source.=(sc)) then a2f.name else a.name endif;    }
}

map classPrimitiveAttributes_LM in umlRdbms {        
    check uml (t:PrimitiveDataType,
        c:Class,
        a:Attribute) {
    }        
    enforce middle (fao:ClassToTable,
        p2n:PrimitiveToName) {
        realize fa:AttributeToColumn    }    
    where () {
        
        fa.attribute := a;        
        fa.kind := a.kind;        
        fa.type := p2n;        
        fa.kind := a.kind;        
        fa.owner := fao;        
        fa.name := a.name;        
        fa.attribute := a;        
        fa.owner := fao;        
        fa.leafs := Set{fa};    }
}

map classComplexAttributes_LM in umlRdbms {        
    check uml (t:Class,
        c:Class,
        a:Attribute) {
    }        
    enforce middle (fao:ClassToTable) {
        realize fa:NonLeafAttribute    }    
    where () {
        
        fa.name := a.name;        
        fa.kind := a.kind;        
        fa.attribute := a;        
        fa.kind := a.kind;        
        fa.owner := fao;        
        fa.owner := fao;        
        fa.leafs := fao.fromAttributes->collect(1_ : umltordbms::FromAttribute[?] | 1_.leafs);        
        fa.attribute := a;    }
}

map complexAttributePrimitiveAttributes_LM in umlRdbms {        
    check uml (ca:Attribute,
        c:Class,
        t:PrimitiveDataType,
        a:Attribute) {
    }        
    enforce middle (fao:NonLeafAttribute,
        p2n:PrimitiveToName) {
        realize fa:AttributeToColumn    }    
    where () {
        
        fa.kind := a.kind;        
        fa.owner := fao;        
        fa.kind := a.kind;        
        fa.attribute := a;        
        fa.owner := fao;        
        fa.attribute := a;        
        fa.name := fao.name.+('_').+(a.name);        
        fa.leafs := Set{fa};        
        fa.type := p2n;    }
}

map complexAttributeComplexAttributes_LM in umlRdbms {        
    check uml (ca:Attribute,
        c:Class,
        t:Class,
        a:Attribute) {
    }        
    enforce middle (fao:NonLeafAttribute) {
        realize fa:NonLeafAttribute    }    
    where () {
        
        fa.leafs := fao.fromAttributes->collect(1_ : umltordbms::FromAttribute[?] | 1_.leafs);        
        fa.owner := fao;        
        fa.attribute := a;        
        fa.attribute := a;        
        fa.kind := a.kind;        
        fa.name := fao.name.+('_').+(a.name);        
        fa.kind := a.kind;        
        fa.owner := fao;    }
}

map attributeColumns_MR in umlRdbms {        
    enforce rdbms (t:Table,
        ct:String) {
        realize c:Column
    }
    check middle (c2t:ClassToTable,
        p2n:PrimitiveToName,
        a2c:AttributeToColumn) {
    }    
    where () {
        
        c.kind := a2c.kind;        
        a2c.column := c;        
        c.name := a2c.name;        
        c.owner := t;        
        c.type := ct;    }
}

map __root__ in umlRdbms {    
    where () {
    }

   for p in simpleuml::Package.allInstances() {
        call packageToSchema_LM {
            p:= p; 
        }

   }

   for p2s in umltordbms::PackageToSchema.allInstances() {
        call packageToSchema_MR {
            p2s:= p2s; 
        }

   }

   for c in simpleuml::Class.allInstances() {
        call classToTable_LM {
            c:= c; 
            p:= c; 
            p2s:= c; 
        }

   }

   for c2t in umltordbms::ClassToTable.allInstances() {
        call classToTable_MR {
            c2t:= c2t; 
            p2s:= c2t; 
            s:= c2t; 
        }

   }

   for a in simpleuml::Association.allInstances() {
        call associationToForeignKey_LM {
            a:= a; 
            p:= a; 
            sc:= a; 
            sc2t:= a; 
            p2s:= a; 
            dc:= a; 
            dc2t:= a; 
        }

   }

   for rk in simplerdbms::Key.allInstances() {
       for a2f in umltordbms::AssociationToForeignKey.allInstances() {
            call associationToForeignKey_MR {
                rk:= rk; 
                a2f:= a2f; 
                dc2t:= a2f; 
                st:= a2f; 
                p2s:= a2f; 
                dt:= a2f; 
                s:= a2f; 
                sc2t:= a2f; 
            }
    
       }
   }

   

   for prim in simpleuml::PrimitiveDataType.allInstances() {
        call stringToVarchar_LM {
            prim:= prim; 
            p:= prim; 
            p2s:= prim; 
        }

   }

   for p2n in umltordbms::StringToVarchar.allInstances() {
        call stringToVarchar_MR {
            p2n:= p2n; 
            p2s:= p2n; 
        }

   }

   for prim in simpleuml::PrimitiveDataType.allInstances() {
        call booleanToBoolean_LM {
            prim:= prim; 
            p:= prim; 
            p2s:= prim; 
        }

   }

   for p2n in umltordbms::BooleanToBoolean.allInstances() {
        call booleanToBoolean_MR {
            p2n:= p2n; 
            p2s:= p2n; 
        }

   }

   for prim in simpleuml::PrimitiveDataType.allInstances() {
        call integerToNumber_LM {
            prim:= prim; 
            p:= prim; 
            p2s:= prim; 
        }

   }

   for a in simpleuml::Attribute.allInstances() {
        call classPrimitiveAttributes_LM {
            a:= a; 
            c:= a; 
            fao:= a; 
            t:= a; 
            p2n:= a; 
        }

   }

   for a in simpleuml::Attribute.allInstances() {
        call classComplexAttributes_LM {
            a:= a; 
            t:= a; 
            fao:= a; 
            c:= a; 
        }

   }

   for a in simpleuml::Attribute.allInstances() {
       for ca in simpleuml::Attribute.allInstances() {
            call complexAttributeComplexAttributes_LM {
                a:= a; 
                t:= a; 
                ca:= ca; 
                c:= ca; 
                fao:= ca; 
            }
    
       }
   }

   

   for a in simpleuml::Attribute.allInstances() {
       for ca in simpleuml::Attribute.allInstances() {
            call complexAttributePrimitiveAttributes_LM {
                a:= a; 
                p2n:= a; 
                c:= a; 
                t:= a; 
                ca:= ca; 
                fao:= ca; 
            }
    
       }
   }

   

   for p2n in umltordbms::IntegerToNumber.allInstances() {
        call integerToNumber_MR {
            p2n:= p2n; 
            p2s:= p2n; 
        }

   }

   for a2c in umltordbms::AttributeToColumn.allInstances() {
        call attributeColumns_MR {
            a2c:= a2c; 
            c2t:= a2c; 
            p2n:= a2c; 
            t:= a2c; 
            ct:= a2c; 
        }

   }

}

